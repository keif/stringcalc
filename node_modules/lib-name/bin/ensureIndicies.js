var db = require('../lib/db')
  , model = require('../lib/model')
	, async = require('async');
db.connect('mongodb://'+(process.env.MONGO_HOST || 'localhost')+'/test');

db.connection.once('open', function () {

	async.waterfall([
		function (next) {
			model.Record.collection.getIndexes(function (err, things) {
				if (err)
					return console.error('MongoDB error: %s', err);
				console.log('Our current indexes', things);
				next();
			});
		}
	, function(next) {
			model.Record.schema.index({name:1});
			next();
		}
	, function(next) {
			model.Record.ensureIndexes(function (err) {
				if (err)
					return console.error('MongoDB error: %s', err);
				next();
			});
		}
	, function (next) {
			model.Record.collection.getIndexes(function (err, things) {
				if (err)
					return console.error('MongoDB error: %s', err);
				console.log(things);	
				console.log('Our current indexes', things);
				next();
			});
		}
	], function(err, results) {
		db.disconnect()
	});

});


